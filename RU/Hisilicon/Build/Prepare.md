# Подготовка

####  **Создание полного дампа с Flash устройства (ff, fullflash)**

**```СТРОГО РЕКОМЕНДУЕТСЯ ПРОДЕЛАТЬ ДАННУЮ МАНИПУЛЯЦИЮ ПЕРЕД ЛЮБЫМИ ЭКСПЕРИМЕНТАМИ !```**
-   Настройте TFTP сервер и проверьте доступ к нему
-   Выполните в консоли, нажав Ctrl+C для остановки загрузки ядра после подачи питания на модуль

    ***Пример создания дампа для 8Mb Flash***
    
    | Команда | Описание |
    |:----------------------------------|:----------------------------------------|
    | ```set serverip 192.168.1.254``` | **```Установка адреса TFTP сервера```** |
    | ```sf probe 0``` | **```Разрешение доступа к флешке```** |
    | ```sf read 0x82000000 0x0 0x800000``` | **```Чтение всей флешки в память```** |
    | ```tftp 0x82000000 ff.img 0x800000``` |**```Выгрузка дампа (fullflash) на TFTP сервер```** |
    <br/>

    ***Пример создания дампа для 16Mb Flash***
    | Команда | Описание |
    |:----------------------------------|:----------------------------------------|
    | ```set serverip 192.168.1.254``` | **```Установка адреса TFTP сервера```** |
    | ```sf probe 0``` | **```Разрешение доступа к флешке```** |
    | ```sf read 0x82000000 0x0 0x1000000``` | **```Чтение всей флешки в память```** |
    | ```tftp 0x82000000 ff.img 0x1000000``` | **```Выгрузка дампа (fullflash) на TFTP сервер```** |
    <br/>
    
    ***Пример создания дампа для 16 Mb Flash на USB флешку (если есть USB порт и метод поддерживается загрузчиком)***

    | Команда | Описание |
    |:----------------------------------|:----------------------------------------|
    | ```usb start``` | **```Инициализация USB```** |
    | ```sf probe 0``` | **```Разрешение доступа к флешке```** |
    | ```sf read 0x82000000 0x0 0x1000000``` | **```Чтение всей флешки в память```** |
    | ```fatwrite usb 0:1 0x82000000 ff.img``` | **```Выгрузка дампа (fullflash) на USB Flash```** |
    <br/>
    После проведения данных операций, у вас появится средство восстановления рабочей системы с заводским ПО.
---

### **Расчет адресов для прошивки на SPI флешку**

Любой адрес, будь то смещение, размер, либо адрес, указывается в 16-ричном виде (```0x00000000```)<br/>
Для того, чтобы получить нужное значение, необходимо 10-чное значение сначала перевести в байты:<br/>
**пример:**<br/>
имеем флешку размером ```8М == 8 * 1024 == 8192Кб == 8192 * 1024 == 8388608 байт```<br/>
Далее берем калькулятор, переводим его в режим "программирование", либо любой онлайн конвертер (https://matworld.ru/calculator/perevod-chisel.php) и в графу 10-чной системы вводим полученное нами количество байт:<br/>
**```8388608(10) == 800000(16) == 0x800000```** - это и есть наш размер флешки в 16-ричном представлении.<br/><br/>
То же самое для ```16M == 16М * 1024 == 16384Кб == 16384 * 1024 == 16777216 байт```<br/>
Те же манипуляции с калькулятором:<br/>
**```16777216(10) == 1000000(16) == 0x1000000```**

---
## Операции с SPI флешкой

Теперь, когда мы научились рассчитывать адреса, попробуем рассчитать разметку для флешки.

---
Имеем на руках 3 файла:

| Файл | Размер | Описание |
|:----------------------------------|:------:|:----------------------------------|
| uboot.bin | ```268776 байт```  | **```первоначальный загрузчик```** |
| uImage | ```3007611 байт``` | **```ядро системы```** |
| rootfs.jffs2 | ```4935148 байт``` | **```корневая система```** |
---
**```НАСТОЯТЕЛЬНО РЕКОМЕНДУЕТСЯ ПЕРЕД ПРОШИВКОЙ UBOOT.BIN ПРОТЕСТИРОВАТЬ ФАЙЛ```**<br/>
---
***Пример для тестирования uboot.bin:***

```mw.b 0x82000000 ff 0x200000; tftp 0x82000000 uboot.bin; go 0x82000000```  
в данном случае происходит следующее:
| Команда | Описание |
|:----------------------------------|:----------------------------------------|
| ```mw.b 0x82000000 ff 0x200000;``` | **```область оперативной памяти по адресу```** ```0x82000000``` <br>**```очищается  в размере 2М (```2 * 1024 * 1024 => 0x200000```)```** |
| ```tftp 0x82000000 uboot.bin;``` | **```в оперативную память по адресу```** ```0x82000000``` <br>**```загружается файл```** **uboot.bin** |
| ```go 0x82000000``` | **```команда "go" используется для исполнения```**<br>**```программы, загруженной в оперативную память```** |

---

**```ТОЛЬКО В СЛУЧАЕ, ЕСЛИ ЗАПУЩЕННЫЙ UBOOT ЗАГРУЗИТСЯ БЕЗ ПРОБЛЕМ И НЕ ПЕРЕЗАГРУЗИЛ ПРОЦЕССОР К СТАРОМУ UBOOT, МОЖНО ПРОДОЛЖАТЬ И ЗАПИСАТЬ ПРОВЕРЕННЫЙ UBOOT В ЭНЕРГОНЕЗАВИСИМУЮ ПАМЯТЬ (SPI-ФЛЕШ)```**  
**```!!! В ПРОТИВНОМ СЛУЧАЕ - ВЫ ПОЛУЧИТЕ "КИРПИЧ" !!!```**
---
Если предыдущий шаг был выполнен успешно, выполняем следующую команду:  
**```mw.b 0x82000000 ff 0x200000; tftp 0x82000000 uboot.bin; sf probe 0; sf erase 0x00 0x1000000; sf write 0x82000000 0x00 $(filesize)```**  

**uboot.bin прошивается всегда по нулевому адресу** - **```0x00```**  

в данном случае происходит следующее:
-   ```mw.b 0x82000000 ff 0x200000;```  - область оперативной памяти по адресу ```0x82000000``` очищается в размере 2М (```2 * 1024 * 1024 => 0x200000```)  
-   ```tftp 0x82000000 uboot.bin;```  - в оперативную память по адресу ```0x82000000``` загружается файл **uboot.bin**
-   ```sf probe 0;``` - загружается модуль для доступа к spi флешке
-   ```sf erase 0x00 0x1000000;``` - очищается вся флешка, от **0** до **16М** (в примере используется **16М** флешка, вы можете заменить на свое значение в байтах и **16**-ричной системе), для **8М** флешки ```0x800000```
-   ```sf write 0x82000000 0x00 $(filesize)``` - производится запись из адреса в оперативной памяти ```0x82000000```, на флешку в адрес ```0x00```, размером ```$(filesize)```. 
Тут ```$(filesize)``` - это переменная в **uboot env**, появляющаяся в случае успешной загрузки файла через tftp.

---

Если предыдущий шаг был выполнен успешно, необходимо перезагрузиться еще раз, для очистки временных переменных в uboot env  
```reset```  

Затем, так как мы обновили uboot в предыдущем шаге, у нас uboot env будет считаться некорректным, поэтому выполняем следующую команду:  
```saveenv```  

примерный вывод команды:  
```
hisilicon # saveenv 
Saving Environment to SPI Flash...
Erasing SPI flash, offset 0x00080000 size 256K ...done
Writing to SPI flash, offset 0x00080000 size 256K ...done
```

Этим действием мы сохраняем на флеш новый конфиг uboot env (дефолтный, предоставленный новым uboot)

---
Теперь, самое страшное уже позади, далее если что то пойдет не так - уже для восстановления не нужен будет специальный SPI программатор, а только UART-консоль с доступом к uboot (что в принципе уже есть, если вы дошли до этого момента:) )

По анаогии с uboot.bin прошиваются остальные файлы. Единственный момент, который может вызвать проблемы у начинающих - это **смещение**.

***Смещение*** - это адрес, в 16-ричном представлении, по которому вы будете записывать следующий файл прошивки.  
 
**Например:**  
Файл uboot.bin мы записали на SPI-флеш по адресу ```0x00```, следующий файл должен находиться по адресу  
```0x00 + (размер файла uboot.bin) + (Размер окружения) + выравнивание```  
***```Размер окружения```*** - это значение, в 16-ричном представлении, которое мы получили из команды ```saveenv```, в данном примере выше это **```256K```**.  
***```Выравнивание```*** - это значение, необходимое для правильного размера ```erase block```.  
Для удобства, расчеты будем вести в 10-чной системе, а в конце переводить в 16-ричную.  
Uboot обычно имеет размер до ```512K```, ядро системы от ```2M``` до ```4M```.  Поэтому нет смысла записывать образы прям в притык.  
Итого: ```512K (uboot) + 256K (env) = 768K = 786432 байт = C0000 (16) = 0xC0000 (16)```  
Типичный размер блока (erase block) == ```64K```, ```786432``` без остатка делится на ```64K * 1024 = 65536```, значит ничего добавлять для выравнивания не нужно.    

Команда для прошивки ядра будет следующая:  
**```mw.b 0x82000000 ff 0x400000; tftp 0x82000000 uImage; sf probe 0; sf erase 0xC0000 0x400000; sf write 0x82000000 0xC0000 $(filesize)```**

где происходит следующее:
-   ```mw.b 0x82000000 ff 0x400000;```  - область оперативной памяти по адресу ```0x82000000``` очищается в размере 4М (```4 * 1024 * 1024 => 0x400000```)  
-   ```tftp 0x82000000 uImage;```  - в оперативную память по адресу ```0x82000000``` загружается файл **uImage**
-   ```sf probe 0;``` - загружается модуль для доступа к spi флешке
-   ```sf erase 0xC0000 0x400000;``` - очищается часть флешки, от адреса **0xC0000** в размере **4М**, вы можете заменить на свое значение в байтах и **16**-ричной системе), например **3М** ```0x300000```
-   ```sf write 0x82000000 0xC0000 $(filesize)``` - производится запись из адреса в оперативной памяти ```0x82000000```, на флешку в адрес ```0xC0000```, размером ```$(filesize)```. 
Тут ```$(filesize)``` - это переменная в **uboot env**, появляющаяся в случае успешной загрузки файла через tftp.  
---
По аналогии с ядром в предыдущем примере, записывается и корневая система, только теперь в смещение добавляется еще и размер ядра (uImage).  