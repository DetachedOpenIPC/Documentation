## Watchdog

### Обзор
Сторожевой таймер используется для передачи "сигнала сброса", для сброса всей системы, после возникновения исключения в системе.

### Особенности
**Сторожевой таймер ("Watchdog")** обеспечивает следующие особенности:

-  32-битный внутренний декрементирующий счетчик. Источник тактовых импульсов может выбираться из 2-х вариантов (кварцевый резонатор и системная шина).
-  Поддерживает настраиваемый интервал ожидания, а именно, начальное значение счетчика.
-  Блокирует регистры, чтобы избежать их изменения.
-  Поддерживает генерацию прерываний по таймауту.
-  Поддерживает генерацию сигналов сброса.
-  Поддерживает режим отладки.

### Принцип взаимодействия
**Сторожевой таймер ("Watchdog")** основан на 32-битном декрементирующем счетчике. 

Начальное значение настраивается с помощью регистра **WDG_LOAD**. 

Когда **"Watchdog"** включен, значение счетчика уменьшается на 1, по переднему фронту каждого тактового сигнала генератора. Когда значение счетчика достигает 0, **"Watchdog"** генерирует прерывание. На следующем переднем фронте тактового сигнала генератора, счетчик перезагружает начальное значение из **WDG_LOAD** и продолжает считать в режиме уменьшения.

Если значение счетчика достигает 0 во второй раз, но ЦП не очищает прерывание сторожевого таймера, сторожевой таймер передает сигнал сброса **WDG_RSTN** и счетчик прекращает счет.

Вы можете включить или отключить сторожевой таймер, настроив **WDG_CONTROL** при необходимости. То есть вы можете контролировать сторожевой таймер, генерировать прерывания или сбрасывать сигналы.

-  Когда функция генерации прерываний отключена, "Watchdog" перестает считать.
-  Когда функция генерации прерываний снова включается, **"Watchdog"** начинает отсчет, начиная с заданного значения **WDG_LOAD** вместо последнего значения счета. Перед созданием прерывания начальное значение может быть перезагружено.

Источник тактовых импульсов сторожевого таймера могут быть часами кварцевого генератора или системной шины, поэтому доступны разные диапазоны времени счета (интервал между тиками).

Настроив **WDG_LOCK**, вы можете отключить операцию записи во внутренние регистры сторожевого таймера.

-  Запись значения ```0x1ACCE551``` в регистр **WDG_LOCK** разрешает запись во все регистры сторожевого таймера.
-  Запись любого другого значения в регистр **WDG_LOCK** блокирует на запись все регистры сторожевого таймера.

Это действие позволяет избежать модификаций регистров сторожевого таймера программным обеспечением. Следовательно, **"Watchdog"** не прерывается по ошибке программным обеспечением, при возникновении исключения.
В режиме отладки сторожевой таймер отключается автоматически, чтобы избежать вмешательства в
нормальную отладку.

### Выбор тактового генератора

Сторожевой таймер поддерживает 2 источника тактового сигнала: 3 MHz кварцевый резонатор и системная шина.
The system supports two types of watchdog count clocks: 3 MHz crystal oscillator clock and
bus clock. Оба источника выбираются конфигурированием регистра **SC_CTRL[wdogenov]**.

Время такта **Twdg** сторожевого таймера расчитывается по формуле:

**Twdg** = **WDG_LOAD_Value** * ( 1 / **Fclk**)

где:

-  **Twdg** - время такта сторожевого таймера.
-  **WDG_LOAD_Value** - значение заданное при инициализации сторожевого таймера.
-  **Fclk** - частота тактового генератора.

Ширина такта при разных генераторах:

-  Когда выбран 3 MHz кварцевый резонатор, от 0 до 1400 секунд 
-  Когда выбрана системная шина (около 100 MHz), 0 до 42 секунд.

### Инициализация

Сторожевой таймер прекращает отсчет после сброса питания системы. Перед инициализацией системы сторожевой таймер должен быть инициализирован и включен. Чтобы инициализировать сторожевой таймер, выполните следующие действия:

-  **Step 1:** Запишите в регистр **WDG_LOAD** начальное значение счетчика.
-  **Step 2:** Запишите в регистр **WDG_CONTROL** значение (примеры приведены ниже), чтобы включить нужный функционал и запустить сторожевой таймер.
-  **Step 3:** Запишите в регистр **WDG_LOCK** любое значение, кроме ```0x1ACCE551```, чтобы заблокировать сторожевой таймер от воздействия на него программного обеспечения.

**----END**

### Обработка прерывания

После получения прерывания от сторожевого таймера, счетчик должен быть очищен, и начальное значение счетчика должно быть повторно загружено в сторожевой таймер для возобновления подсчета.

Прерывание обрабатывается следующим образом:

-  **Step 1:** Запишите значение ```0x1ACCE551```  в регистр **WDG_LOCK** для снятия защиты сторожевого таймера.
-  **Step 2:** Запишите в регистр **WDG_INTCLR** 
любое значение, для очистки прерывания и загрузки начального значения счетчика и рестарта сторожевого таймера.
-  **Step 3:** Запишите в регистр **WDG_LOCK** любое значение, кроме ```0x1ACCE551```, чтобы заблокировать сторожевой таймер от воздействия на него программного обеспечения.

**----END**

### Отключение сторожевого таймера
Вы можете изменять состояние сторожевого таймера записью в регистр **WDG_CONTROL[inten]** значений:
-  ```0```: выключен
-  ```1```: включен

## Информация о регистрах (базовый адрес: ```0x2004_0000```)

| Смещение регистра    | Register    | Описание                                   | Значение сброса         | Доступ |
|----------------------|-------------|--------------------------------------------|:-----------------------:|:------:|
| ```0x0000```         | WDG_LOAD    | Регистр начального значения счетчика       | ```0xFFFF_FFFF```       | RW     |
| ```0x0004```         | WDG_VALUE   | Регистр текущего значения счетчика         | ```0xFFFF_FFFF```       | RO     |
| ```0x0008```         | WDG_CONTROL | Регистр управления сторожевым таймером     | ```0x0000_0000```       | RW     |
| ```0x000C```         | WDG_INTCLR  | Регистр очистки прерывания                 | -                       | WO     |
| ```0x0010```         | WDG_RIS     | Регистр статуса прерывания                 | ```0x0000_0000```       | RO     |
| ```0x0014```         | WDG_MIS     | Регистр маскированного статуса прерывания  | ```0x0000_0000```       | RO     |
| ```0x0018–0x0BFC```  | RESERVED    | Зарезервировано                            | -                       |        |
| ```0x0C00```         | WDG_LOCK    | Регистр блокировки                         | ```0x0000_0000```       | RW     |


## Описание регистров

-  **WDG_LOAD** - регистр начального состояния счетчика. Он используется для установки начального количества тиков до срабатывания прерывания.

	**пример:** ```himm 0x20040000 0x0000000F``` (установка 15 тиков)
***
-  **WDG_VALUE** - регистр текущего состояния счетчика. Он используется для получения оставшихся до срабатывания прерывания тиков.

	**пример:** ```himm 0x20040004``` (получить оставшееся количество тиков)
***
-  **WDG_CONTROL** - управляющий регистр. Используется для включения-выключения сторожевого таймера, и выбора функций прерывания или рестарта.
	-  (resen) Включение-выключение выхода сигнала резет.
		-  ```0```: выключен
		-  ```1```: включен
	-  (inten) Включение-выключение сторожевого таймера.
		-  ```0```: Счетчик прекращает отсчет, текущее значение счетчика остается неизменным, и сторожевой таймер отключен.
		-  ```1```: Счетчик, прерывание и сторожевой таймер включены.

    | resen | inten | value           |       ---------------      | resen | inten | value           |
    |:-----:|:-----:|:---------------:|----------------------------|:-----:|:-----:|:---------------:|
    | 0     | 0     | ```0x00```      |       ---------------      | 1     | 0     | ```0x02```      |
    | 0     | 1     | ```0x01```      |       ---------------      | 1     | 1     | ```0x03```      |
    
    **пример:** ```himm 0x20040008 0x03``` (сигнал резет и сторожевой таймер включены)
***
-  **WDG_INTCLR** - регистр очистки прерываний. Он используется для очистки прерываний сторожевого таймера, чтобы сторожевой таймер мог перезагрузить начальное значение для подсчета. Этот регистр только для записи. Когда значение записывается в этот регистр, прерывания сторожевого таймера очищаются. Никакое значений этот регистр не возвращает и значение регистра по умолчанию не определено.

	**пример:** ```himm 0x2004000C 0x01``` (очистить прерывание)
***
-  **WDG_RIS** - регистр raw статуса прерывания. Он показывает raw статус прерывания сторожевого таймера. Когда значение счетчика достигает 0, этот бит устанавливается в 1.
		- ```0```: прерывание не сгенерировано.
		- ```1```: прерывание сгенерировано.

	**пример:** ```himm 0x20040010``` (получить статус регистра)
***
-  **WDG_MIS** - регистр скрытого состояния прерывания. Показывает скрытое состояние прерывания сторожевого таймера.
		- 0: прерывание не сгенерировано либо прерывание скрыто.
		- 1: прерывание сгенерировано.

	**пример:** ```himm 0x20040014``` (получить статус регистра)
***
-  **WDG_LOCK** - регистр блокировки сторожевого таймера. Служит для управления блокировки чтения-записи в регистры сторожевого таймера.
	-  Запись значения ```0x1ACCE551``` в данный регистр снимает блокировку и разрешает чтение-запись в регистры сторожевого таймера.
	-  Запись любого другого значения блокирует доступ ко всем регистрам сторожевого таймера

    **пример:** ```himm 0x20040C00 0x1ACCE551``` (разблокировать сторожевой таймер)

    **пример:** ```himm 0x20040C00 0x01``` (заблокировать сторожевой таймер)

	-  Когда происходит чтение из данного регистра, возвращается статус регистра, а не записанное в него значение
		-  ```0x0000_0000```: Доступ на запись разрешен (разблокировано).
		-  ```0x0000_0001```: Доступ на запись запрещен (заблокировано).

    **пример:** ```himm 0x20040C00``` (прочитать статус доступа)

